extern buffer

# ── Constructor & basic ops ───────────────────────────────────────

buf := buffer.new()
print(buffer.length(buf))       # 0
print(buffer.capacity(buf))     # 256

# ── Write / read single bytes ────────────────────────────────────

buffer.write_byte(buf, 'A')
buffer.write_byte(buf, 'B')
buffer.write_byte(buf, 255)
print(buffer.length(buf))       # 3

buffer.reset(buf)
print(buffer.read_u8(buf))      # 65
print(buffer.read_u8(buf))      # 66
print(buffer.read_u8(buf))      # 255

# ── Write / read bytes from string ───────────────────────────────

buffer.clear(buf)
buffer.write_bytes(buf, "Hello")
print(buffer.length(buf))       # 5
buffer.reset(buf)
s := buffer.read_bytes(buf, 5)
print(s)                        # Hello

# ── Signed vs unsigned byte read ─────────────────────────────────

buffer.clear(buf)
buffer.write_byte(buf, 200)     # 0xC8 — unsigned 200, signed -56
buffer.reset(buf)
print(buffer.read_u8(buf))      # 200
buffer.reset(buf)
print(buffer.read_i8(buf))      # -56

# ── 16-bit little endian ─────────────────────────────────────────

buffer.clear(buf)
buffer.write_i16_le(buf, 0x0102)
print(buffer.length(buf))       # 2
buffer.reset(buf)
print(buffer.read_u16_le(buf))  # 258

# ── 16-bit big endian ────────────────────────────────────────────

buffer.clear(buf)
buffer.write_i16_be(buf, 0x0102)
buffer.reset(buf)
print(buffer.read_u16_be(buf))  # 258

# ── 32-bit endianness ────────────────────────────────────────────

buffer.clear(buf)
buffer.write_i32_le(buf, 0x01020304)
buffer.reset(buf)
print(buffer.read_u32_le(buf))  # 16909060

buffer.clear(buf)
buffer.write_i32_be(buf, 0x01020304)
buffer.reset(buf)
print(buffer.read_u32_be(buf))  # 16909060

# ── 64-bit endianness ────────────────────────────────────────────

buffer.clear(buf)
buffer.write_i64_le(buf, 1000000000000)
buffer.reset(buf)
print(buffer.read_i64_le(buf))  # 1000000000000

buffer.clear(buf)
buffer.write_i64_be(buf, 1000000000000)
buffer.reset(buf)
print(buffer.read_i64_be(buf))  # 1000000000000

# ── Signed 16-bit read ───────────────────────────────────────────

buffer.clear(buf)
buffer.write_i16_le(buf, -1000)
buffer.reset(buf)
print(buffer.read_i16_le(buf))  # -1000

buffer.clear(buf)
buffer.write_i16_be(buf, -1000)
buffer.reset(buf)
print(buffer.read_i16_be(buf))  # -1000

# ── Signed 32-bit read ───────────────────────────────────────────

buffer.clear(buf)
buffer.write_i32_le(buf, -100000)
buffer.reset(buf)
print(buffer.read_i32_le(buf))  # -100000

buffer.clear(buf)
buffer.write_i32_be(buf, -100000)
buffer.reset(buf)
print(buffer.read_i32_be(buf))  # -100000

# ── Float 32 ─────────────────────────────────────────────────────

buffer.clear(buf)
buffer.write_f32_le(buf, 3.14)
print(buffer.length(buf))       # 4
buffer.reset(buf)
# f32 precision: ~3.14000010...
f32_val := buffer.read_f32_le(buf)
# Just check it round-trips close enough
if f32_val > 3.13 and f32_val < 3.15
    print("f32_le ok")
end

buffer.clear(buf)
buffer.write_f32_be(buf, 3.14)
buffer.reset(buf)
f32_be := buffer.read_f32_be(buf)
if f32_be > 3.13 and f32_be < 3.15
    print("f32_be ok")
end

# ── Float 64 ─────────────────────────────────────────────────────

buffer.clear(buf)
buffer.write_f64_le(buf, 3.141592653589793)
print(buffer.length(buf))       # 8
buffer.reset(buf)
print(buffer.read_f64_le(buf))  # 3.141593

buffer.clear(buf)
buffer.write_f64_be(buf, 2.718281828459045)
buffer.reset(buf)
print(buffer.read_f64_be(buf))  # 2.718282

# ── Zero-terminated strings ──────────────────────────────────────

buffer.clear(buf)
buffer.write_str_zt(buf, "Hello")
buffer.write_str_zt(buf, "World")
print(buffer.length(buf))      # 12 (5+1+5+1)
buffer.reset(buf)
print(buffer.read_str_zt(buf)) # Hello
print(buffer.read_str_zt(buf)) # World

# ── Length-prefixed strings (non-terminated) ─────────────────────

buffer.clear(buf)
msg := "Bismut"
buffer.write_i32_be(buf, len(msg))
buffer.write_bytes(buf, msg)
msg2 := "Rocks"
buffer.write_i32_be(buf, len(msg2))
buffer.write_bytes(buf, msg2)
print(buffer.length(buf))      # 18 (4+5+4+5)

buffer.reset(buf)
n1 := buffer.read_u32_be(buf)
s1 := buffer.read_bytes(buf, n1)
n2 := buffer.read_u32_be(buf)
s2 := buffer.read_bytes(buf, n2)
print(s1)                      # Bismut
print(s2)                      # Rocks

# ── Cursor / seek / remaining ────────────────────────────────────

buffer.clear(buf)
buffer.write_byte(buf, 10)
buffer.write_byte(buf, 20)
buffer.write_byte(buf, 30)
buffer.reset(buf)
print(buffer.remaining(buf))    # 3
print(buffer.read_u8(buf))      # 10
print(buffer.pos(buf))          # 1
print(buffer.remaining(buf))    # 2
buffer.seek(buf, 0)
print(buffer.read_u8(buf))      # 10

# ── from_str ─────────────────────────────────────────────────────

buf2 := buffer.from_str("ABCD")
print(buffer.length(buf2))      # 4
print(buffer.read_u8(buf2))     # 65
print(buffer.read_u8(buf2))     # 66

# ── to_str / slice ───────────────────────────────────────────────

buffer.clear(buf)
buffer.write_bytes(buf, "Hello World")
result := buffer.to_str(buf)
print(result)                   # Hello World
part := buffer.slice(buf, 6, 5)
print(part)                     # World

# ── Network packet example: write header then read back ──────────

buffer.clear(buf)
# Simulated packet: version(u8) + type(u8) + length(u16 BE) + payload
buffer.write_byte(buf, 1)               # version
buffer.write_byte(buf, 42)              # message type
buffer.write_i16_be(buf, 5)             # payload length (BE = network order)
buffer.write_bytes(buf, "Hello")        # payload

buffer.reset(buf)
version := buffer.read_u8(buf)
msg_type := buffer.read_u8(buf)
payload_len := buffer.read_u16_be(buf)
payload := buffer.read_bytes(buf, payload_len)
print(version)                          # 1
print(msg_type)                         # 42
print(payload_len)                      # 5
print(payload)                          # Hello

print("ok")
